version: '3'

vars:
  CLUSTER_NAME: pvc-chonker-test
  IMAGE_NAME: pvc-chonker:test

tasks:
  setup:
    desc: Setup Kind cluster and deploy operator
    cmds:
      - kind create cluster --config=kind-config.yaml --wait=60s
      - kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.24/deploy/local-path-storage.yaml
      - kubectl wait --for=condition=Available deployment/local-path-provisioner -n local-path-storage --timeout=60s
      - kubectl apply -f storage-class.yaml
      - docker build -t {{.IMAGE_NAME}} ../..
      - kind load docker-image {{.IMAGE_NAME}} --name={{.CLUSTER_NAME}}
      - kubectl apply -f ../../config/
      - kubectl wait --for=condition=Available deployment/pvc-chonker-controller-manager -n pvc-chonker-system --timeout=60s

  run:
    desc: Run E2E tests
    cmds:
      - go mod tidy
      - ginkgo -v

  cleanup:
    desc: Delete Kind cluster
    cmds:
      - kind delete cluster --name={{.CLUSTER_NAME}}